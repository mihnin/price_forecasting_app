import streamlit as st
import pandas as pd
import os
import sys

# –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ª–∏–º–∏—Ç —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ Pandas Styler
pd.set_option("styler.render.max_elements", 1000000)  # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ª–∏–º–∏—Ç –≤ 1 –º–∏–ª–ª–∏–æ–Ω —ç–ª–µ–º–µ–Ω—Ç–æ–≤

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ –º–æ–¥—É–ª—è–º
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –º–æ–¥—É–ª–∏
from modules.data_loader import DataLoader
from modules.data_processor import DataProcessor
from modules.data_analyzer import DataAnalyzer
from modules.visualization import Visualizer
from modules.material_segmentation import MaterialSegmenter
from modules.forecasting_preparation import ForecastPreparation
from modules.security_analyzer import SecurityAnalyzer
from modules.utils import apply_custom_css, show_user_guide, show_performance_info, show_app_version

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
st.set_page_config(
    page_title="–ê–Ω–∞–ª–∏–∑ –∏ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–µ–Ω –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤",
    page_icon="üìä",
    layout="wide",
    initial_sidebar_state="expanded"
)

# –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π CSS
apply_custom_css()

# –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç—ã –º–æ–¥—É–ª–µ–π
data_loader = DataLoader()
data_processor = DataProcessor()
data_analyzer = DataAnalyzer()
visualizer = Visualizer()
material_segmenter = MaterialSegmenter()
forecast_preparation = ForecastPreparation()
security_analyzer = SecurityAnalyzer()

# –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å
with st.sidebar:
    st.header("–ù–∞–≤–∏–≥–∞—Ü–∏—è")
    page = st.radio(
        "–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:",
        ["–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è", "–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö", "–û–±—â–∏–π –∞–Ω–∞–ª–∏–∑", "–ê–Ω–∞–ª–∏–∑ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤", 
         "–í—Ä–µ–º–µ–Ω–Ω–æ–π –∞–Ω–∞–ª–∏–∑", "–ê–Ω–∞–ª–∏–∑ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏", "–°—Ç–∞–±–∏–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã", 
         "–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã", "–°–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è", "–ê–Ω–∞–ª–∏–∑ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏", "–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö"]
    )
    
    st.divider()
    st.header("–°—Ç–∞—Ç—É—Å")
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ —Å–µ—Å—Å–∏–∏
    if 'data' in st.session_state:
        st.success(f"–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã: {st.session_state.data.shape[0]} —Å—Ç—Ä–æ–∫")
        if 'processed_data' in st.session_state:
            st.success("–î–∞–Ω–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã")
        if 'materials_segments' in st.session_state:
            st.success("–ú–∞—Ç–µ—Ä–∏–∞–ª—ã —Å–µ–≥–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã")
            
            # –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ —Å–µ–≥–º–µ–Ω—Ç–∞–º
            segments_stats = st.session_state.get('segments_stats', {})
            if segments_stats:
                st.write("–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤:")
                for segment, count in segments_stats.items():
                    st.write(f"- {segment}: {count}")
    else:
        st.warning("–î–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã")

# –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
st.title("–ê–Ω–∞–ª–∏–∑ –∏ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–µ–Ω –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤")

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
def display_info():
    st.info("""
    –≠—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–æ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –¥–∞–Ω–Ω—ã—Ö –æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞—Ö –∏ –∏—Ö —Ü–µ–Ω–∞—Ö, 
    –∞ —Ç–∞–∫–∂–µ –¥–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∫ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—é —Ü–µ–Ω —Å –ø–æ–º–æ—â—å—é —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤ –º–∞—à–∏–Ω–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è.
    
    –ó–∞–≥—Ä—É–∑–∏—Ç–µ CSV-—Ñ–∞–π–ª —Å –¥–∞–Ω–Ω—ã–º–∏ –æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞—Ö, –∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–∏—Ç –∞–Ω–∞–ª–∏–∑, 
    –æ–ø—Ä–µ–¥–µ–ª–∏—Ç –º–∞—Ç–µ—Ä–∏–∞–ª—ã, –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è, –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç –¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.
    """)
    
    # –î–æ–±–∞–≤–ª—è–µ–º —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    with st.expander("–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", expanded=False):
        show_user_guide()
        
    # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è —Å–ª—É–∂–± –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
    with st.expander("–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è —Å–ª—É–∂–± –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"):
        st.markdown("""
        ## –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –¥–ª—è —Å–ª—É–∂–± –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
        
        –î–∞–Ω–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤–∫–ª—é—á–∞–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –º–æ–¥—É–ª—å –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –≤ –¥–∞–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞:
        - –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –º–æ—à–µ–Ω–Ω–∏—á–µ—Å–∫–∏–µ —Å—Ö–µ–º—ã
        - –ú–∞–Ω–∏–ø—É–ª—è—Ü–∏–∏ —Å —Ü–µ–Ω–∞–º–∏
        - –î—Ä–æ–±–ª–µ–Ω–∏–µ –∑–∞–∫—É–ø–æ–∫ –¥–ª—è –æ–±—Ö–æ–¥–∞ –ø—Ä–æ—Ü–µ–¥—É—Ä
        - –ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –≤ –∫–æ–Ω—Ü–µ –æ—Ç—á–µ—Ç–Ω—ã—Ö –ø–µ—Ä–∏–æ–¥–æ–≤
        - –ù–µ—Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∑–∞–∫—É–ø–æ—á–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–∞—Ö
        
        ### –ö–ª—é—á–µ–≤—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Ä–∏—Å–∫–∞:
        
        1. **–í—ã—Å–æ–∫–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å —Ü–µ–Ω**
           - –ú–∞—Ç–µ—Ä–∏–∞–ª—ã —Å –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–º –≤–∞—Ä–∏–∞—Ü–∏–∏ –±–æ–ª–µ–µ 50%
           - –ù–µ–æ–±—ä—è—Å–Ω–∏–º—ã–µ —Å–∫–∞—á–∫–∏ —Ü–µ–Ω –º–µ–∂–¥—É –∑–∞–∫—É–ø–∫–∞–º–∏
        
        2. **–î—Ä–æ–±–ª–µ–Ω–∏–µ –∑–∞–∫—É–ø–æ–∫**
           - –ú–Ω–æ–∂–µ—Å—Ç–≤–æ –Ω–µ–±–æ–ª—å—à–∏—Ö –∑–∞–∫—É–ø–æ–∫ —Å –∫–æ—Ä–æ—Ç–∫–∏–º–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞–º–∏
           - –ó–∞–∫—É–ø–∫–∏ –Ω–∞ —Å—É–º–º—ã –Ω–∏–∂–µ –ø–æ—Ä–æ–≥–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
        
        3. **–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –≤ –∫–æ–Ω—Ü–µ –ø–µ—Ä–∏–æ–¥–æ–≤**
           - –ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è –∑–∞–∫—É–ø–æ–∫ –≤ –∫–æ–Ω—Ü–µ –º–µ—Å—è—Ü–∞/–∫–≤–∞—Ä—Ç–∞–ª–∞/–≥–æ–¥–∞
           - –ü–æ–≤—ã—à–µ–Ω–∏–µ —Ü–µ–Ω –≤ –∫–æ–Ω—Ü–µ –æ—Ç—á–µ—Ç–Ω—ã—Ö –ø–µ—Ä–∏–æ–¥–æ–≤
        
        4. **–ê–Ω–æ–º–∞–ª—å–Ω–∞—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å —Ü–µ–Ω**
           - –ù–µ–µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ —Å—Ç–∞–±–∏–ª—å–Ω—ã–µ —Ü–µ–Ω—ã –Ω–∞ –≤–æ–ª–∞—Ç–∏–ª—å–Ω—ã—Ö —Ä—ã–Ω–∫–∞—Ö
           - –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ –æ–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–µ —Å—É–º–º—ã
        
        5. **–ù–∞—Ä—É—à–µ–Ω–∏—è —Å–µ–∑–æ–Ω–Ω–æ—Å—Ç–∏**
           - –ó–∞–∫—É–ø–∫–∏ –≤ –Ω–µ—Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã–µ –¥–ª—è —Ç–æ–≤–∞—Ä–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–µ—Ä–∏–æ–¥—ã
           - –ü—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–µ –æ–±—â–∏–º —Ä—ã–Ω–æ—á–Ω—ã–º —Ç–µ–Ω–¥–µ–Ω—Ü–∏—è–º
        
        ### –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–æ–¥—É–ª—å –∞–Ω–∞–ª–∏–∑–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:
        
        1. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏ –æ–±—Ä–∞–±–æ—Ç–∞–π—Ç–µ –¥–∞–Ω–Ω—ã–µ
        2. –í—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—é –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
        3. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª "–ê–Ω–∞–ª–∏–∑ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"
        4. –ò–∑—É—á–∏—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã —Å –≤—ã—Å–æ–∫–∏–º –∏–Ω–¥–µ–∫—Å–æ–º –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        5. –í—ã–ø–æ–ª–Ω–∏—Ç–µ –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –∏–∑ –≥—Ä—É–ø–ø—ã —Ä–∏—Å–∫–∞
        6. –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –æ—Ç—á–µ—Ç –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è
        
        **–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –û—Å–æ–±–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ —Å–ª–µ–¥—É–µ—Ç —É–¥–µ–ª–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º –∏–∑ —Å–µ–≥–º–µ–Ω—Ç–∞ "–í—ã—Å–æ–∫–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å", —Ç–∞–∫ –∫–∞–∫ –≤ —ç—Ç–æ–º —Å–µ–≥–º–µ–Ω—Ç–µ –Ω–∞–∏–±–æ–ª–µ–µ —á–∞—Å—Ç–æ –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞—é—Ç—Å—è –ø—Ä–∏–∑–Ω–∞–∫–∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –Ω–∞—Ä—É—à–µ–Ω–∏–π.
        """)

# –û—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
if page == "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è":
    display_info()

elif page == "–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö":
    data_loader.render()
    
    if 'data' in st.session_state:
        if st.button("–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ"):
            with st.spinner("–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö..."):
                st.session_state.processed_data = data_processor.process_data(st.session_state.data)
                st.success("–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã!")
                
                # –ü–æ–∫–∞–∑–∞—Ç—å –æ–±—Ä–∞–∑–µ—Ü –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                st.subheader("–û–±—Ä–∞–∑–µ—Ü –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö")
                st.dataframe(st.session_state.processed_data.head())

elif page == "–û–±—â–∏–π –∞–Ω–∞–ª–∏–∑":
    if 'processed_data' in st.session_state:
        data_analyzer.render_overview(st.session_state.processed_data)
    else:
        st.warning("–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∏ –æ–±—Ä–∞–±–æ—Ç–∞–π—Ç–µ –¥–∞–Ω–Ω—ã–µ")

elif page == "–ê–Ω–∞–ª–∏–∑ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤":
    if 'processed_data' in st.session_state:
        data_analyzer.render_materials_uniqueness(st.session_state.processed_data)
        visualizer.plot_materials_distribution(st.session_state.processed_data)
    else:
        st.warning("–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∏ –æ–±—Ä–∞–±–æ—Ç–∞–π—Ç–µ –¥–∞–Ω–Ω—ã–µ")

elif page == "–í—Ä–µ–º–µ–Ω–Ω–æ–π –∞–Ω–∞–ª–∏–∑":
    if 'processed_data' in st.session_state:
        data_analyzer.render_time_analysis(st.session_state.processed_data)
        visualizer.plot_time_distribution(st.session_state.processed_data)
    else:
        st.warning("–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∏ –æ–±—Ä–∞–±–æ—Ç–∞–π—Ç–µ –¥–∞–Ω–Ω—ã–µ")

elif page == "–ê–Ω–∞–ª–∏–∑ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏":
    if 'processed_data' in st.session_state:
        material_segmenter.analyze_volatility(st.session_state.processed_data)
        visualizer.plot_volatility(st.session_state.volatility_data)
    else:
        st.warning("–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∏ –æ–±—Ä–∞–±–æ—Ç–∞–π—Ç–µ –¥–∞–Ω–Ω—ã–µ")

elif page == "–°—Ç–∞–±–∏–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã":
    if 'processed_data' in st.session_state:
        material_segmenter.analyze_stability(st.session_state.processed_data)
        visualizer.plot_stability(st.session_state.stability_data)
    else:
        st.warning("–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∏ –æ–±—Ä–∞–±–æ—Ç–∞–π—Ç–µ –¥–∞–Ω–Ω—ã–µ")

elif page == "–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã":
    if 'processed_data' in st.session_state:
        material_segmenter.analyze_inactivity(st.session_state.processed_data)
        visualizer.plot_inactivity(st.session_state.inactivity_data)
    else:
        st.warning("–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∏ –æ–±—Ä–∞–±–æ—Ç–∞–π—Ç–µ –¥–∞–Ω–Ω—ã–µ")

elif page == "–°–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è":
    if 'processed_data' in st.session_state:
        st.header("–°–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è")
        
        # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏–∏
        with st.expander("–ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏–∏", expanded=True):
            col1, col2, col3 = st.columns(3)
            
            with col1:
                min_data_points = st.slider("–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ—á–µ–∫ –¥–∞–Ω–Ω—ã—Ö", 5, 100, 24)
            
            with col2:
                max_volatility = st.slider("–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –≤–∞—Ä–∏–∞—Ü–∏–∏ (%)", 1, 100, 30)
            
            with col3:
                min_activity_days = st.slider("–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏", 30, 1000, 365)
        
        if st.button("–í—ã–ø–æ–ª–Ω–∏—Ç—å —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—é"):
            with st.spinner("–°–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤..."):
                segments, stats = forecast_preparation.segment_materials(
                    st.session_state.processed_data,
                    min_data_points=min_data_points,
                    max_volatility=max_volatility,
                    min_activity_days=min_activity_days
                )
                
                st.session_state.materials_segments = segments
                st.session_state.segments_stats = stats
                
                st.success("–°–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!")
                
                # –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏–∏
                visualizer.plot_segmentation_results(segments, stats)
    else:
        st.warning("–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∏ –æ–±—Ä–∞–±–æ—Ç–∞–π—Ç–µ –¥–∞–Ω–Ω—ã–µ")
elif page == "–ê–Ω–∞–ª–∏–∑ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏":
    if 'processed_data' in st.session_state and 'materials_segments' in st.session_state:
        # –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∞–ª–∏–∑ –¢–û–õ–¨–ö–û –µ—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –µ—â–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ —Å–µ—Å—Å–∏–∏
        if 'security_risks' not in st.session_state:
            with st.spinner("–ê–Ω–∞–ª–∏–∑ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö..."):
                st.session_state.security_risks = security_analyzer.analyze_security_risks(
                    st.session_state.processed_data, 
                    st.session_state.materials_segments
                )

        # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
        if 'security_risks' in st.session_state and st.session_state.security_risks is not None:
            security_analyzer.display_security_analysis_results(st.session_state.security_risks)
        
            # –ö–Ω–æ–ø–∫–∞ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –∑–¥–µ—Å—å, –Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Ä–∏—Å–∫–∏
            if not st.session_state.security_risks.empty and st.button("–ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –¥–ª—è –º–∞—Ç–µ—Ä–∏–∞–ª–∞ —Å –≤—ã—Å–æ–∫–∏–º —Ä–∏—Å–∫–æ–º"):
                # –í—ã–±–∏—Ä–∞–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª —Å –Ω–∞–∏–≤—ã—Å—à–∏–º –∏–Ω–¥–µ–∫—Å–æ–º –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏–∑ –°–û–•–†–ê–ù–ï–ù–ù–´–• —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                high_risk_material = st.session_state.security_risks.iloc[0]['–ú–∞—Ç–µ—Ä–∏–∞–ª']
                # –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ (–æ–Ω–∞ –Ω–µ —Å–æ–∑–¥–∞–µ—Ç –∫–Ω–æ–ø–∫–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è, –≤—Å–µ –≤ –ø–æ—Ä—è–¥–∫–µ)
                security_analyzer.highlight_suspicious_materials(st.session_state.processed_data, high_risk_material)
        else:
             st.info("–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –∏–ª–∏ –Ω–µ –±—ã–ª–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã.")

    elif 'processed_data' not in st.session_state:
        st.warning("–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∏ –æ–±—Ä–∞–±–æ—Ç–∞–π—Ç–µ –¥–∞–Ω–Ω—ã–µ")
    else:
        st.warning("–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—é –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –≤ —Ä–∞–∑–¥–µ–ª–µ '–°–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è'")
        
        if st.button("–ü–µ—Ä–µ–π—Ç–∏ –∫ —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏–∏"):
            st.session_state.page = "–°–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è"
            st.experimental_rerun()
    
elif page == "–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö":
    if 'materials_segments' in st.session_state:
        st.header("–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö")
        
        st.markdown("""
        ## –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö
        
        –í —ç—Ç–æ–º —Ä–∞–∑–¥–µ–ª–µ –≤—ã –º–æ–∂–µ—Ç–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å–µ–≥–º–µ–Ω—Ç–æ–≤ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ 
        –≤ —Ñ–æ—Ä–º–∞—Ç—ã CSV –∏–ª–∏ Excel –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö.
        
        –î–æ—Å—Ç—É–ø–Ω—ã–µ –æ–ø—Ü–∏–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞:
        - **–≠–∫—Å–ø–æ—Ä—Ç –ø–æ —Å–µ–≥–º–µ–Ω—Ç–∞–º** - —ç–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –æ—Ç–¥–µ–ª—å–Ω–æ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–µ–≥–º–µ–Ω—Ç–∞
        - **–ú–∞—Å—Å–æ–≤—ã–π —ç–∫—Å–ø–æ—Ä—Ç** - —ç–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö —Å–µ–≥–º–µ–Ω—Ç–æ–≤ –≤ –æ–¥–∏–Ω ZIP-–∞—Ä—Ö–∏–≤
        - **–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–π —ç–∫—Å–ø–æ—Ä—Ç** - —ç–∫—Å–ø–æ—Ä—Ç —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ —Ä–∞–∑–ª–∏—á–Ω—ã–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º
        """)
        
        # –í—ã–∑—ã–≤–∞–µ–º –º–µ—Ç–æ–¥ —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö
        forecast_preparation.export_data_options(st.session_state.materials_segments)
    else:
        st.warning("–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—é –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –≤ —Ä–∞–∑–¥–µ–ª–µ '–°–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è'")
        
        if st.button("–ü–µ—Ä–µ–π—Ç–∏ –∫ —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏–∏"):
            # –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏–∏
            st.session_state.page = "–°–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è"
            st.experimental_rerun()

# Footer
st.divider()

# –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
show_performance_info()

# –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≤–µ—Ä—Å–∏–∏
show_app_version()

st.caption("¬© 2025 –ê–Ω–∞–ª–∏–∑ –∏ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–µ–Ω –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤")